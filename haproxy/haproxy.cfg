global
    log stdout format raw local0 info
    maxconn 8192
    # Em Docker, NÃO usar daemon (processo deve ficar em foreground)
    # daemon

defaults
    log     global
    mode    http
    option  httplog
    timeout connect 5s
    timeout client  60s
    timeout server  60s
    timeout tunnel  1h

frontend main
    bind *:80
    mode http

    # =====================================================
    # IMPORTANTE: A ORDEM DAS ACLs E USE_BACKEND IMPORTA!
    # Regras mais específicas devem vir ANTES das genéricas
    # =====================================================

    # 1. Frontend Vite (DEV – mais específico)
    acl is_vite_internal path_beg /@vite/ /@fs/ /@react-refresh
    acl is_src_files     path_beg /src/ /node_modules/
    acl is_vite_hmr      path_beg /__vite_ping
    acl is_vite_ws_path  path_reg ^/\?token=

    # 2. MediaMTX (ANTES do Streaming Service)
    acl is_hls            path_beg /hls/
    acl is_webrtc_direct  path_beg /webrtc/
    acl is_cam_stream     path_beg /cam_
    acl is_streaming_hls  path_beg /streaming/hls/

    # 3. AI Detection Service (DISABLED)
    # acl is_ai_api path_beg /api/ai/

    # 4. Streaming Service (ANTES do /api/ genérico)
    acl is_streaming_api path_beg /api/streaming/ /streaming/
    acl is_streaming_ws  path_beg /ws/events/ /ws/dashboard

    # 5. Django/Admin via Kong
    acl is_admin path_beg /admin/
    acl is_api   path_beg /api/

    # 6. Estáticos via Nginx
    acl is_static path_beg /static/ /media/

    # =====================================================
    # ROTEAMENTO
    # =====================================================

    # Frontend Vite (PRIMEIRO)
    use_backend frontend_dev if is_vite_internal
    use_backend frontend_dev if is_src_files
    use_backend frontend_dev if is_vite_hmr
    use_backend frontend_dev if is_vite_ws_path

    # MediaMTX (PRIMEIRO)
    use_backend mediamtx_hls if is_hls
    use_backend mediamtx_hls if is_cam_stream
    use_backend mediamtx_hls_legacy if is_streaming_hls
    use_backend mediamtx_webrtc if is_webrtc_direct

    # AI Detection (DISABLED)
    # use_backend ai_detection_service if is_ai_api

    # Streaming
    use_backend streaming_service if is_streaming_api
    use_backend streaming_service if is_streaming_ws

    # Django / Kong
    use_backend kong_gateway if is_admin
    use_backend kong_gateway if is_api

    # Estáticos
    use_backend nginx_static if is_static

    # Default → Frontend
    default_backend frontend_dev

# =====================================================
# BACKENDS
# =====================================================

# backend ai_detection_service
#     mode http
#     http-request replace-path /api/ai/(.*) /ai/\1
#     server ai_detection1 ai_detection:8002 check

backend streaming_service
    mode http
    http-request replace-path /api/streaming/(.*) /\1
    http-request replace-path /streaming/(.*) /\1
    server streaming1 streaming:8001 check

backend mediamtx_hls
    mode http
    http-request replace-path /hls/(.*) /\1
    server mediamtx1 mediamtx:8888 check

backend mediamtx_hls_legacy
    mode http
    http-request replace-path /streaming/hls/cam_([0-9]+)/(.*) /cam_\1/\2
    server mediamtx1 mediamtx:8888 check

backend mediamtx_webrtc
    mode http
    stick-table type ip size 100k expire 30m
    stick on src
    server mediamtx1 mediamtx:8889 check

backend kong_gateway
    mode http
    server kong1 kong:8000 check

backend nginx_static
    mode http
    server nginx1 nginx:80 check

# ❗ FRONTEND DEV (Vite)
# ❗ SEM healthcheck — Vite retorna 403 para bots
backend frontend_dev
    mode http
    option httpchk GET /
    http-check expect status 200,403
    server frontend1 frontend:5173 check

# =====================================================
# STATS
# =====================================================
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s


