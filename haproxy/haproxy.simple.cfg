global
    log stdout format raw local0 info
    maxconn 4096

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5s
    timeout client  60s
    timeout server  60s
    timeout tunnel  3600s

# Frontend principal
frontend main
    bind *:80
    mode http
    
    # ACLs
    acl is_streaming_api path_beg /api/streaming/
    acl is_health path /health
    acl is_metrics path /metrics
    
    # Routing
    use_backend streaming_service if is_streaming_api
    use_backend streaming_service if is_health
    use_backend streaming_service if is_metrics
    
    # Default: retornar 404
    default_backend no_backend

# Backends
backend streaming_service
    mode http
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    server streaming1 streaming:8001 check inter 5s

backend no_backend
    mode http
    http-request deny deny_status 404

# Stats Dashboard
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
