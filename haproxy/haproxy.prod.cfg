global
    log stdout format raw local0 info
    maxconn 8192
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    option  http-server-close
    option  forwardfor except 127.0.0.0/8
    timeout connect 5s
    timeout client  60s
    timeout server  60s
    timeout tunnel  3600s
    timeout http-request 10s
    timeout http-keep-alive 10s
    retries 3

# Rate Limiting Tables
frontend main
    bind *:80
    bind *:443 ssl crt /etc/haproxy/certs/gtvision.pem
    mode http
    
    # Redirect HTTP to HTTPS
    http-request redirect scheme https code 301 if !{ ssl_fc }
    
    # Rate Limiting
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny deny_status 429 if { sc_http_req_rate(0) gt 100 }
    
    # Security Headers
    http-response set-header X-Frame-Options SAMEORIGIN
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-XSS-Protection "1; mode=block"
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains"
    
    # ACLs - Order matters!
    acl is_hls path_beg /hls/
    acl is_webrtc path_beg /webrtc/
    acl is_streaming_api path_beg /api/streaming/
    acl is_streaming_ws path_beg /ws/
    acl is_admin path_beg /admin/
    acl is_api path_beg /api/
    acl is_static path_beg /static/ /media/
    acl is_metrics path /metrics
    acl is_health path /health
    
    # Routing
    use_backend mediamtx_hls if is_hls
    use_backend mediamtx_webrtc if is_webrtc
    use_backend streaming_service if is_streaming_api
    use_backend streaming_service if is_streaming_ws
    use_backend kong_gateway if is_admin
    use_backend kong_gateway if is_api
    use_backend nginx_static if is_static
    use_backend health_check if is_health
    http-request deny if is_metrics
    
    default_backend frontend_prod

# Backends with Health Checks
backend streaming_service
    mode http
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    http-request replace-path /api/streaming/(.*) /\1
    server streaming1 streaming:8001 check inter 5s rise 2 fall 3
    server streaming2 streaming:8001 check inter 5s rise 2 fall 3 backup

backend mediamtx_hls
    mode http
    balance leastconn
    option httpchk GET /
    http-check expect status 200
    server mediamtx1 mediamtx:8888 check inter 10s

backend mediamtx_webrtc
    mode http
    balance source
    stick-table type ip size 100k expire 30m
    stick on src
    server mediamtx1 mediamtx:8889 check inter 10s

backend kong_gateway
    mode http
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    server kong1 kong:8000 check inter 5s rise 2 fall 3

backend nginx_static
    mode http
    balance roundrobin
    server nginx1 nginx:80 check inter 10s

backend frontend_prod
    mode http
    server frontend1 frontend:80 check inter 10s

backend health_check
    mode http
    http-request return status 200 content-type text/plain string "OK"

# Stats Dashboard
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats auth admin:gtvision_stats_2025
    stats admin if TRUE
