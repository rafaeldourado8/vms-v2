_format_version: "3.0"

# Services
services:
  - name: django-admin
    url: http://backend:8000
    routes:
      - name: admin-route
        paths:
          - /api/admin
        strip_path: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
    plugins:
      - name: jwt
        config:
          key_claim_name: sub
          secret_is_base64: false
      - name: rate-limiting
        config:
          minute: 100
          hour: 1000
          policy: local
      - name: cors
        config:
          origins:
            - http://localhost:5173
            - http://localhost:3000
          credentials: true
          max_age: 3600

  - name: django-cidades
    url: http://backend:8000
    routes:
      - name: cidades-route
        paths:
          - /api/cidades
        strip_path: false
    plugins:
      - name: jwt
      - name: rate-limiting
        config:
          minute: 200
          policy: local
      - name: cors
        config:
          origins:
            - http://localhost:5173
          credentials: true

  - name: streaming-service
    url: http://streaming:8001
    routes:
      - name: streaming-route
        paths:
          - /api/streaming
        strip_path: false
    plugins:
      - name: jwt
      - name: rate-limiting
        config:
          minute: 500
          policy: local
      - name: cors
        config:
          origins:
            - http://localhost:5173
          credentials: true

  - name: ai-service
    url: http://streaming:8001
    routes:
      - name: ai-route
        paths:
          - /api/ai
        strip_path: false
    plugins:
      - name: jwt
      - name: rate-limiting
        config:
          minute: 300
          policy: local
      - name: cors
        config:
          origins:
            - http://localhost:5173
          credentials: true

  - name: auth-service
    url: http://streaming:8001
    routes:
      - name: auth-route
        paths:
          - /api/auth
        strip_path: false
    plugins:
      - name: rate-limiting
        config:
          minute: 10
          policy: local
      - name: cors
        config:
          origins:
            - http://localhost:5173
          credentials: true

# Global Plugins
plugins:
  - name: prometheus
    config:
      per_consumer: true
  
  - name: request-transformer
    config:
      add:
        headers:
          - X-Kong-Request-ID:$(uuid)
  
  - name: response-transformer
    config:
      add:
        headers:
          - X-Kong-Response-Time:$(latency)

# Consumers (JWT)
consumers:
  - username: admin
    custom_id: admin-user
    jwt_secrets:
      - key: admin-jwt-key
        secret: gtvision_jwt_secret_2025_change_in_production

  - username: gestor
    custom_id: gestor-user
    jwt_secrets:
      - key: gestor-jwt-key
        secret: gtvision_jwt_secret_2025_change_in_production

  - username: visualizador
    custom_id: visualizador-user
    jwt_secrets:
      - key: visualizador-jwt-key
        secret: gtvision_jwt_secret_2025_change_in_production
